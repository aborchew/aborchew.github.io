angular.module("cohortsApp",["ngRoute","ngAnimate","ui.bootstrap"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",resolve:{data:["$q","$http",function(a,b){var c=a.defer();return b.get("scripts/json/data.json").success(function(a){c.resolve(a)}).error(function(){c.reject("failed to load json")}),c.promise}]}})}]),angular.module("cohortsApp").controller("MainCtrl",["$scope","data",function(a,b){a.data=b,a.selectedStat="HealthScore";for(var c=0,d=a.data.length;d>c;c++){5>c&&(a.data[c].visible=!0);for(var e=0,f=a.data[c].historicalData.length;f>e;e++)a.data[c].historicalData[e].eventId=Math.random().toString(36).substring(7)}}]),angular.module("cohortsApp").directive("cohortsChart",["$rootScope","$filter","$timeout","$compile","$window","$q",function(a,b,c,d,e,f){return{templateUrl:"partials/cohortsChart.html",restrict:"E",scope:{data:"=data",selectedStat:"=selectedStat"},replace:!0,link:{pre:function(a,c){a.margin={top:10,right:10,bottom:20,left:40},a.duration={tracerFadeIn:500,tracerFadeOut:250,drawLine:1e3,drawLineStep:250,unDrawLine:250,eventFadeIn:250,eventFadeInStep:100,eventFadeOutStep:100,eventFadeOut:100,eventHoverIn:100,eventHoverOut:100},a.elem=$(c),a.x,a.y,a.xAxis,a.yAxis,a.xAxisGroup,a.yAxisGroup,a.cohortsContainer,a.cohorts,a.x=d3.scale.linear(),a.y=d3.scale.pow().exponent(2),a.xAxis=d3.svg.axis().scale(a.x).tickFormat(function(a){return a%30==0?a:null}).orient("bottom"),a.yAxis=d3.svg.axis().scale(a.y).tickSize(10,4,-10).ticks(20).tickFormat(function(a){return a%25==0?a+"%":null}).orient("left"),a.line=d3.svg.line().x(function(b){return a.x(b.day)}).y(function(b){return a.y(b[a.selectedStat])}).interpolate("cardinal"),a.svg=d3.select(c[0]).select("svg.chart"),a.cohortsContainer=a.svg.append("g").attr("transform","translate("+a.margin.left+","+a.margin.top+")"),a.xAxisGroup=a.cohortsContainer.append("g").attr("class","x axis"),a.yAxisGroup=a.cohortsContainer.append("g").attr("class","y axis"),a.cohortsContainer=a.cohortsContainer.append("g").attr("class","cohorts"),a.cohorts=a.cohortsContainer.selectAll("g.cohort").data(a.data).enter().append("g").attr("class","cohort"),a.cohorts.append("path").attr("d",function(b){return a.line(b.historicalData)}),a.cohorts.each(function(a){var c=b("filter")(a.historicalData,function(a){return a.Event});d3.select(this).append("circle").attr("class","tracer").attr("filter","url(#blur)"),d3.select(this).selectAll(".event").data(c).enter().append("circle").attr("class",function(a){return"event event-"+a.Event})}),a.events=a.cohorts.selectAll(".event").attr("r",20).attr("tooltip-append-to-body",!0).attr("tooltip",function(a){return a.Event+" ("+a.day+" day"+(a.day>1?"s)":")")}).attr("opacity",0).on("mouseenter",function(){d3.select(this).transition().duration(a.duration.eventHoverIn).attr("r",10)}).on("mouseleave",function(){d3.select(this).transition().duration(a.duration.eventHoverOut).attr("r",3)})},post:function(b,g){function h(a){var b=a.getTotalLength();return function(){return function(c){var d=a.getPointAtLength(c*b);return"translate("+d.x+","+d.y+")"}}}function i(a){d3.select(a).selectAll(".tracer").attr("r",0).attr("opacity",0).attr("cx",function(a){return b.x(a.historicalData[0].day)}).attr("cy",function(a){return b.y(a.historicalData[0][b.selectedStat])}).attr("transform","translate(0,0)"),d3.select(a).selectAll("path").attr("stroke-dasharray",function(){var a=d3.select(this).node().getTotalLength();return a+" "+a}).attr("stroke-dashoffset",function(){return d3.select(this).node().getTotalLength()}),d3.select(a).selectAll(".events").attr("opacity",0).attr("r",20)}function j(d){var e=f.defer();return i(d),d3.select(d).selectAll(".tracer").each(function(){d3.select(this).transition().duration(b.duration.tracerFadeIn).attr("r",7).attr("opacity",1).each("end",function(){d3.select(d).selectAll(".tracer").each(function(){d3.select(this).attr("cx",0).attr("cy",0).transition().duration(b.duration.drawLine).ease("cubic").attrTween("transform",h(d3.select(d).select("path").node()))}),d3.select(d).selectAll("path").style("opacity",1).transition().duration(b.duration.drawLine).ease("cubic").attr("stroke-dashoffset",0).each("end",function(){var f=d3.select(d).selectAll(".event")[0].length;f||e.reject(),d3.select(d).selectAll(".event").each(function(d,g){var h=d3.select(this);h.attr("cx",function(a){return b.x(a.day)}).attr("cy",function(a){return b.y(a[b.selectedStat])}),c(function(){h.transition().duration(b.duration.eventFadeIn).ease("cubic").attr("opacity",1).attr("r",3).each("end",function(){d3.select(this).attr("tooltip",function(a){return a.Event+" ("+a.day+" day"+(a.day>1?"s)":")")}),f-=1,a.$broadcast("showEvent",d.eventId),f||e.resolve()})},b.duration.eventFadeInStep*g)}),d3.select(d).selectAll(".tracer").transition().duration(b.duration.tracerFadeOut).attr("r",0).attr("opacity",0)})})}),e.promise}function k(d){for(var e=f.defer(),g=d3.select(d).selectAll(".event")[0].reverse(),h=0,i=g.length;i>h;h++){var j=function(d){c(function(){d3.select(g[d]).attr("tooltip",null).transition().duration(b.duration.eventFadeOut).ease("linear").attr("opacity",0).attr("r",20),a.$broadcast("hideEvent",d3.select(g[d]).data()[0].eventId)},b.duration.eventFadeOutStep*d)};j(h)}return d3.select(d).selectAll("path").transition().duration(b.duration.unDrawLine).style("opacity",0).attr("stroke-dasharray",function(){d3.select(this).node().getTotalLength()}).attr("stroke-dashoffset",function(){return d3.select(this).node().getTotalLength()}).each("end",function(){d3.select(this).selectAll(".event").transition().duration(b.duration.eventFadeOut).attr("opacity",0).attr("r",20)}),e.promise}b.sizeCanvas=function(){b.width=b.elem.width(),b.height=b.elem.height(),b.x.range([0,b.width-b.margin.left-b.margin.right]),b.y.range([b.height-b.margin.top-b.margin.bottom,0]),b.svg.attr("width",b.width).attr("height",b.height),b.xAxisGroup.attr("transform","translate(0,"+(b.height-b.margin.bottom-b.margin.top)+")"),b.xAxisGroup.call(b.xAxis),b.yAxisGroup.call(b.yAxis),b.cohorts.selectAll("path").attr("d",function(a){return b.line(a.historicalData)})},b.render=function(d){b.sizeCanvas(),b.x.domain([1,90]),b.y.domain([0,100]),d&&(b.events.attr("opacity",0).attr("r",20),a.$broadcast("hideEvents"),b.cohorts.selectAll("path").attr("d",function(a){return b.line(a.historicalData)}),b.cohorts.each(function(a,d){i(this);var e=this;a.visible&&c(function(){j(e).then(function(){b.recompile()})},d*b.duration.drawLineStep)}),c(function(){b.recompile()},50)),b.cohorts.each(function(a){a.visible?a.visible&&d3.select(this).select("path").style("opacity")<1&&j(this).then(function(){b.recompile()}):k(this).then(function(){b.recompile()})}).selectAll("path").attr("d",function(a){return b.line(a.historicalData)})},b.recompile=function(){d(g)(b)},b.$watch(function(){return b.selectedStat},function(a,c){angular.equals(a,c)||b.render(!0)}),b.$watch(function(){return b.data},function(a,c){angular.equals(a,c)||b.render(!1)},!0),angular.element(e).bind("resize",function(){c(b.sizeCanvas,0)}),b.render(!0),b.sizeCanvas()}}}}]),angular.module("cohortsApp").directive("cohortsFeed",["$filter",function(a){return{templateUrl:"partials/cohortsFeed.html",restrict:"E",scope:{data:"=data"},link:function(b){b.displayData=function(){for(var a=[],c=0,d=b.data.length;d>c;c++)a[a.length]=b.data[c].historicalData;return d3.merge(a)},b.$on("showEvent",function(c,d){var e=a("filter")(b.displayData(),{eventId:d});e.length&&(e[0].visible=!0)}),b.$on("hideEvent",function(c,d){var e=a("filter")(b.displayData(),{eventId:d});e.length&&(e[0].visible=!1)}),b.$on("hideEvents",function(){angular.forEach(b.displayData(),function(a){a.visible=!1})})}}}]);