"use strict";angular.module("cohorts2App",["ngAnimate","ui.bootstrap"]).run(["$rootScope","$http","$timeout","UTCohorts",function(a,b,c,d){a.cohorts=[],a.days=90,c(function(){b.get("scripts/json/cohorts.json").success(function(b){a.cohorts=new d(b)})},0)}]),angular.module("cohorts2App").controller("MainCtrl",["$scope",function(a){function b(){for(var b=0,c=a.events.length;c>b;b++){var d=new Date,e=d.getDate()-a.days+a.events[b].day;d.setDate(e),a.events[b].date=d}}function c(){a.filters=[],a.filters=a.filters,angular.forEach(a.cohorts.getEventTypes(),function(b){a.filters[a.filters.length]={value:b,selected:!0}}),b(),d(),a.rendered=!0}function d(){a.$watch(function(){return a.filters},function(){a.events=a.cohorts.getEvents(a.filters)},!0)}a.eventLabels={NDF:"No Defect Found",Fault:"Fault",Fix:"Fix"},a.selectedStat="HealthScore",a.transitionTime=250,a.drawDuration=1500,a.timeBegins=1,a.getEventLabel=function(b){return a.eventLabels[b]||b},a.getSvgData=function(a){switch(a){case"NDF":return"M16,23.5L10.8,16L16,8.5l5.2,7.5L16,23.5z M13.8,16l2.2,3.4l2.2-3.4L16,12.6L13.8,16z";case"Fix":return"M19.2,23.5h-6.4v-4.3H8.5v-6.4h4.3V8.5h6.4v4.3h4.3v6.4h-4.3V23.5z M14.8,21.5h2.5v-4.3h4.3v-2.5h-4.3v-4.3 h-2.5v4.3h-4.3v2.5h4.3V21.5z";case"Fault":return"M16,23.5c-4.2,0-7.5-3.3-7.5-7.5s3.3-7.5,7.5-7.5s7.5,3.3,7.5,7.5S20.2,23.5,16,23.5z M16,11.2 c-2.7,0-4.8,2.1-4.8,4.8s2.1,4.8,4.8,4.8s4.8-2.1,4.8-4.8S18.7,11.2,16,11.2z";case"arrow":return"10,15.4 18.2,19.7 10,0.1 1.8,19.7";default:return"M16,23.5L10.8,16L16,8.5l5.2,7.5L16,23.5z M13.8,16l2.2,3.4l2.2-3.4L16,12.6L13.8,16z"}},a.sortWithTime=function(a){return console.log(arguments),a},a.$watch(function(){return a.cohorts},function(b,d){"function"==typeof a.cohorts.getEvents&&(a.events=a.cohorts.getEvents(),d.length||c())},!0)}]),angular.module("cohorts2App").directive("utPreloader",["$timeout",function(a){return{templateUrl:"partials/utPreloader.html",restrict:"A",scope:{items:"=utPreloader",fadeDuration:"=utFadeDuration"},link:function(b,c){angular.element(c).addClass("utPreloader"),b.$watch(function(){return b.items},function(){b.items.length?(angular.element(c).addClass("fadeOut"),angular.element(c).removeClass("visible"),a(function(){angular.element(c).removeClass("fadeOut"),angular.element(c).addClass("hidden")},b.fadeDuration)):(angular.element(c).addClass("fadeIn"),angular.element(c).removeClass("hidden"),a(function(){angular.element(c).removeClass("fadeIn"),angular.element(c).addClass("visible")},b.fadeDuration))},!0)}}}]),angular.module("cohorts2App").directive("utDataFeed",["$rootScope",function(){return{templateUrl:"partials/utDataFeed.html",restrict:"A",link:function(a,b){angular.element(b).addClass("ut-data-feed")}}}]),angular.module("cohorts2App").service("UTCohorts",["$filter",function(a){return function(b){var c=function(a){return a};return c.prototype=Array.prototype,angular.forEach(Array.prototype,function(a){console.log(a)}),c.prototype.getEvents=function(){for(var c=[],d=0,e=b.length;e>d;d++)c.push.apply(c,a("filter")(b[d].historicalData,function(a){return a.Event}));return c},c.prototype.getEventTypes=function(a){for(var b=this.getEvents(),c=[],d=0,e=b.length;e>d;d++)(a&&b[d].visible&&-1==c.indexOf(b[d].Event)||!a&&-1==c.indexOf(b[d].Event))&&(c[c.length]=b[d].Event);return c},new c(b)}}]),angular.module("cohorts2App").filter("utDataFeedFilter",["$filter",function(a){return function(b,c,d){var e=[],f=a("filter")(c,{selected:!0});if(f)for(var g=0,h=f.length;h>g;g++)e.push.apply(e,a("filter")(b,{Event:f[g].value,visible:!0}));var i=a("filter")(e,function(a){return a.day<d}),j=a("filter")(e,function(a){return a.day>=d});return i.sort(function(a,b){return a.day-b.day}),j.sort(function(a,b){return a.day-b.day}),j.concat(i)}}]);var elem;angular.module("cohorts2App").directive("utChart",["$rootScope","$window","$filter","$timeout","$q","$interval",function(a,b,c,d,e,f){return{templateUrl:"partials/utChart.html",restrict:"A",link:function(a,e,g){function h(){function e(b){var d=function(){return d3.merge(function(){var b=[];return angular.forEach(a.cohorts,function(a){b[b.length]=a.historicalData}),b}())}();if(d.length<2)return!1;var e=function(){for(var e=[],f=1,g=b?100:E.time.domain()[1];g>=f;f++){var h=c("filter")(d,function(a){return angular.equals(a.day,f)});e[e.length]={day:f,min:d3.min(h,function(b){return b[a.selectedStat]}),max:d3.max(h,function(b){return b[a.selectedStat]})}}return e}();return e}function g(){H={chart:angular.element(B.node()).innerWidth(),assets:angular.element(C.node()).innerWidth(),time:angular.element(D.node()).innerWidth()},I={chart:angular.element(B.node()).innerHeight(),assets:angular.element(C.node()).innerHeight(),time:angular.element(D.node()).innerHeight()},E.time.range([0,H.chart-G.chart.left-G.chart.right]),E.score.range([I.chart-G.chart.top-G.chart.bottom,0]),F.time.tickFormat(function(a){return a%Math.floor(E.time.domain()[1]/3)==0?a:null}),B.selectAll("g.scale.time").call(F.time).attr("transform","translate("+(G.time.left-2)+","+(I.chart-G.chart.bottom)+")"),B.selectAll("g.scale.score").call(F.score).attr("transform","translate("+(G.time.left-2)+","+G.chart.top+")"),j.attr("transform","translate("+G.chart.left+","+G.chart.top+")"),k.datum(e(!0)),l.datum(e(!0)),o.attr("width",H.time-G.time.left-G.time.right+2).attr("height",3).attr("transform","translate("+(G.time.left-3)+",17)"),p.attr("width",H.time-G.time.left-G.time.right+2).attr("height",3).attr("transform","translate("+(G.time.left-3)+",32)"),q.attr("height",3).attr("transform","translate("+(G.time.left-3)+",17)"),s.attr("width",20).attr("height",75).attr("transform","translate("+(G.time.left-5)+",0)"),y.attr("x",function(){return H.chart-this.getBBox().width-G.chart.right+10}),z.attr("x",function(){return H.chart-this.getBBox().width-G.chart.right+20}),K?(d(function(){k.datum(e(!0)).attr("d",i).attr("opacity",0).transition().duration(a.transitionTime).attr("opacity",1),l.datum(e(!0)).attr("d",i).attr("opacity",0).transition().duration(a.transitionTime).attr("opacity",1)},a.drawDuration),n=m.selectAll("path").attr("d",function(a){return h(a.historicalData)}).attr("stroke-dasharray",function(){var a=d3.select(this).node().getTotalLength();return a+" "+a}).attr("stroke-dashoffset",function(){return d3.select(this).node().getTotalLength()}).transition().duration(a.drawDuration).ease("linear").attr("stroke-dasharray",function(){var a=d3.select(this).node().getTotalLength();return a+" 0"}).attr("stroke-dashoffset",function(){return 0}).each("end",function(){u(),v.transition().duration(0).attr("opacity",1)}),angular.forEach(a.cohorts,function(b){var c=E.time.domain()[1];f(function(c){b.historicalData[c].Event&&(b.historicalData[c].visible=!0,A.append("path").attr("d",a.getSvgData(b.historicalData[c].Event)).attr("transform",function(){var d=d3.select(this).node().getBoundingClientRect(),e=E.time(b.historicalData[c].day)-d.width,f=E.score(b.historicalData[c][a.selectedStat])-d.height;return"translate("+e+","+f+")"}).attr("class","event"))},a.drawDuration/c,c)}),K=!1):(n=m.selectAll("path").transition().duration(a.transitionTime).attr("d",function(a){return h(a.historicalData)}),k.datum(e(!0)).transition().duration(a.transitionTime).attr("d",i),l.datum(e(!0)).transition().duration(a.transitionTime).attr("d",i),a.events.sort(function(a,b){return a.day===b.day?a.Train-b.Train:a.day-b.day}),d3.selectAll("path.event").transition(a.transitionTime).attr("transform",function(b,c){var d=d3.select(this).node().getBoundingClientRect(),e=E.time(a.events[c].day)-d.width,f=E.score(a.events[c][a.selectedStat])-d.height;return"translate("+e+","+f+")"}),u(!0))}var h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B=d3.select("#chart").append("svg"),C=d3.select("#assets").append("svg"),D=d3.select("#time").append("svg"),E={time:d3.scale.linear(),score:d3.scale.linear(),assets:d3.scale.linear()},F={time:d3.svg.axis().scale(E.time).orient("bottom"),score:d3.svg.axis().scale(E.score).orient("left").tickValues([0,25,50,75,100])},G={chart:{top:50,right:30,bottom:30,left:50},assets:{top:50,right:5,bottom:5,left:10},time:{top:10,right:30,bottom:30,left:50}},H={},I={},J={},K=!0,L=[];u=function(b){var f,g,h,i,j=d3.event?d3.event.x-G.chart.left:b?t:0;if(j=j>E.time.range()[1]?E.time.range()[1]:j,j=j<E.time.range()[0]?E.time.range()[0]:j,t!=j||b){h=E.time.invert(j),i=e(),i=i.splice(h-1,1),f=d3.max(i,function(a){return a.max}),g=d3.min(i,function(a){return a.min}),s.attr("x",function(){return(b?t:j)-d3.select(this).attr("width")/2+3}),s.select("polyline").attr("transform",function(){return"translate("+((b?t:j)-d3.select(this).attr("width")/2-7)+",20)"}),q.attr("width",b?t:j),v.attr("x1",b?t:j).attr("x2",b?t:j).attr("y1",0).attr("y2",I.chart-G.chart.bottom),w.transition().duration(b?a.transitionTime:0).attr("x1",b?t:j).attr("x2",H.chart-G.chart.left).attr("y1",E.score(f)).attr("y2",E.score(f)).attr("opacity",1),x.transition().duration(b?a.transitionTime:0).attr("x1",b?t:j).attr("x2",H.chart-G.chart.left).attr("y1",E.score(g)).attr("y2",E.score(g)).attr("opacity",1),t=b?t:j,L=[];for(var k=0,l=a.cohorts.length;l>k;k++)L[L.length]=c("filter")(a.cohorts[k].historicalData,{day:Math.floor(h)})[0];d(function(){a.timeBegins=Math.floor(h)})}},r=d3.behavior.drag().on("dragstart",function(){d3.event.sourceEvent.stopPropagation()}).on("drag",u),o=D.append("rect").attr("class","mouse-area"),p=D.append("rect").attr("class","mouse-area2"),q=D.append("rect").attr("class","mouse-area selected"),s=D.append("g").attr("class","drag-area").call(r),s.append("polyline").attr("points",a.getSvgData("arrow")).attr("transform","translate(-7,20)"),E.time.domain([1,90]),E.score.domain([0,100]),B.append("g").attr("class","scale time"),B.append("g").attr("class","scale score"),h=d3.svg.line().x(function(a){return E.time(a.day)}).y(function(b){return E.score(b[a.selectedStat])}).interpolate("cardinal"),j=B.append("g").attr("class","area"),k=j.append("path"),l=j.append("path").attr("class","path-mask"),i=d3.svg.area().interpolate("cardinal").x(function(a){return E.time(a.day)}).y0(function(a){return E.score(a.min)}).y1(function(a){return E.score(a.max)}),m=B.selectAll("g.train").data(a.cohorts).enter().append("g").attr("transform","translate("+G.chart.left+","+G.chart.top+")").attr("class","train"),m.append("path"),n=m.selectAll("path"),z=B.append("rect"),y=B.append("text").attr("class","asset-count").attr("y",G.chart.top-20).text("Assets in cohort: "+a.cohorts.length),z.attr("class","asset-count-bg").attr("y",G.chart.top-35).attr("height",24).attr("rx",3).attr("ry",3).attr("width",function(){return y.node().getBBox().width+20}),A=B.append("g").attr("class","events").attr("transform","translate("+G.chart.left+","+G.chart.top+")"),J=B.append("g").attr("class","crosshairs"),v=J.append("line").attr("class","crosshair x").attr("opacity",0).attr("transform","translate("+(G.chart.left-2)+",0)"),w=J.append("line").attr("class","crosshair y0").attr("opacity",0).attr("transform","translate("+(G.chart.left-2)+","+G.chart.top+")"),x=J.append("line").attr("class","crosshair y1").attr("opacity",0).attr("transform","translate("+(G.chart.left-2)+","+G.chart.top+")"),angular.element(b).bind("resize",function(){g()}),a.$watch(function(){return a.selectedStat},function(){g()})}angular.element(e).addClass("ut-chart"),a.transitionTime=a[g.transitionTime]||250,a.drawDuration=a[g.drawDuration]||1500,a.$watch(function(){return a.cohorts},function(a,b){(b.length||a&&!b||a.length!=b.length)&&h()})}}}]);