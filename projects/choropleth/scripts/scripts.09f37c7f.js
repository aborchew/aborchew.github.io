"use strict";angular.module("choroplethApp",["ngAnimate","ngSanitize","ui.bootstrap"]),angular.module("choroplethApp").controller("MainCtrl",["$scope","$http","$q","$filter","$window","$timeout","$modal","$location","RangeColors",function(a,b,c,d,e,f,g,h,i){function j(a){return d("filter")(M,{id:a},!0)[0].stateName}function k(a){return d("filter")(M,{id:a},!0)[0].legendLabels}function l(a){return H?H(a):"inherit"}function m(a,b){var c=d("filter")(M,{id:b},!0);return 1===c.length&&c[0].colorScale?c[0].colorScale(a):"inherit"}function n(a){var b=parseInt(a)||this.score.id,c=d("filter")(topojson.feature(F,F.objects.states).features,{id:b},!0)[0];o(c)}function o(b){Q=!1,a.selectedStore=null;var c,e,g,i,j=d("filter")(M,{id:b.id},!0);if(i=2,b&&b.id&&1===j.length){if(b&&(z&&z.id!==b.id||!z)){var k=C.centroid(b);c=k[0],e=k[1],g=4,z=b,h.search("s",b.id)}else c=x/i,e=y/i,g=1,z=null,h.search("s",null);B.selectAll("path").classed("active",z&&function(a){return a===z}),B.transition().duration(P).attr("transform","translate("+x/i+","+y/i+")scale("+g+")translate("+-c+","+-e+")").style("stroke-width",1.5/g+"px"),E.transition().duration(P).attr("transform","translate("+x/i+","+y/i+")scale("+g+")translate("+-c+","+-e+")").selectAll("circle.location").attr("class",function(a){return z&&a.stateId===z.id?"location visible":"location"}).attr("r",function(a){return z&&a.stateId===z.id?1:0}).attr("data-store-id",function(a){return"store"+a.storeId}),P=750,f(function(){a.selectedStateId=z?z.id:null},0)}}function p(){var a=D.select("[data-state-id=state"+this.score.id+"]");a.classed("hovered",!0)}function q(){var a=D.select("[data-state-id=state"+this.score.id+"]");a.classed("hovered",!1)}function r(){if(!Q){var a=this.location.storeId,b=E.select("[data-store-id=store"+a+"]");E.selectAll("circle.location").sort(function(b,c){return b.storeId!==a?-1:1}),b.classed("hovered",!0).transition().duration(500).attr("r",5)}}function s(){if(!Q){var a=this.location.storeId,b=E.select("[data-store-id=store"+a+"]");b.classed("hovered",!1).transition().duration(500).attr("r",1)}}function t(){var a;if(x=angular.element("#map").width(),y=.65*x,!x)return void f(t,0);a=d3.geo.albersUsa().scale(x).translate([x/2,y/2]),C=d3.geo.path().projection(a),D=d3.select("#map").append("svg").attr("width",x).attr("height",y),angular.forEach(M,function(a){a.total=a.tallies.reduce(function(a,b){return a+b},0),a.average=a.total/a.tallies.length});var b,c=d3.min(M,function(a){return a[S]}),e=d3.max(M,function(a){return a[S]}),g=(e+c)/2;H=d3.scale.linear().domain([c,(g+c)/2,g,(g+e)/2,e]).range(L),b=["<= "+Math.floor(H.domain()[0]),Math.floor(H.domain()[1])+" +",Math.floor(H.domain()[2])+" +",Math.floor(H.domain()[3])+" +",">= "+Math.floor(H.domain()[4])],B=D.append("g"),B.append("g").attr("class","states").selectAll("path").data(topojson.feature(F,F.objects.states).features).enter().append("path").attr("d",C).on("click",o).attr("data-state-id",function(a){return"state"+a.id}).attr("fill",function(a){var b=d("filter")(M,{id:a.id},!0);return 1===b.length?(a.hasScore=!0,a.scoreColor=H(b[0][S]),a.scoreColor):void 0}).classed("state",function(a){return a.hasScore}).on("mouseover",function(a){a.hasScore&&d3.select(this).classed("hovered",!0)}).on("mouseout",function(a){a.hasScore&&d3.select(this).classed("hovered",!1)}),B.append("path").datum(topojson.mesh(F,F.objects.states,function(a,b){return a!==b})).attr("class","state-borders").attr("d",C),E=D.append("g"),E.selectAll("circle.location").data(G).enter().append("circle").attr("class","location").attr("r",1).attr("transform",function(b){return"translate("+a([b.longitude,b.latitude])+")"});var h=D.selectAll("g.legend").data(H.domain()).enter().append("g").attr("class","legend"),i=20,j=20;h.append("rect").attr("x",20).attr("y",function(a,b){return y-b*j-2*j}).attr("width",i).attr("height",j).style("fill",function(a,b){return H(a)}).style("opacity",.8),h.append("text").attr("x",50).attr("y",function(a,b){return y-b*j-j-4}).text(function(a,c){return b[c]})}function u(){new Date-I<O?setTimeout(u,O):(D.classed("resizing",!1),N=!1,D.remove(),z=null,t(),A&&(P=0,o(A),A=null))}function v(){angular.forEach(h.search(),function(a,b){switch(b){case"l":var c=d("filter")(G,{storeId:a},!0);1===c.length?w(c[0]):h.search("l",null);break;case"s":n(a)}})}function w(a){var a=a||this.location;h.search("l",a.storeId);var b=g.open({templateUrl:"views/location.html",controller:"LocationCtrl",size:"lg",resolve:{location:function(){return a}}});b.result.then(function(){h.search("l",null)},function(){h.search("l",null)})}var x,y,z,A,B,C,D,E,F,G,H,m,I,J=b.get("scripts/us.json"),K=b.get("scripts/locationsList.json"),L=i,M=[],N=!1,O=250,P=750,Q=!1,R=!0,S="average",T="average";c.all([J,K]).then(function(a){F=a[0].data,G=a[1].data.response.rowsX,angular.forEach(G,function(a){var b=a.stateId,c=1e4,e=1,f=d("filter")(M,{id:b},!0);a.metric=Math.floor(Math.random()*(c-e))+e+1,1!==f.length?M.push({tallies:[a.metric],stateName:a.state,id:b}):f[0].tallies.push(a.metric)}),angular.forEach(M,function(a){var b=d3.min(a.tallies),c=d3.max(a.tallies),d=(b+c)/2;a.colorScale=d3.scale.linear().domain([b,(d+b)/2,d,(d+c)/2,c]).range(L),a.legendLabels=["<= "+Math.floor(a.colorScale.domain()[0]),Math.floor(a.colorScale.domain()[1])+" +",Math.floor(a.colorScale.domain()[2])+" +",Math.floor(a.colorScale.domain()[3])+" +",">= "+Math.floor(a.colorScale.domain()[4])]}),t(),v()}),e.onresize=function(){A=z,I=new Date,D.classed("resizing",!0),N===!1&&(N=!0,setTimeout(u,O))},a.scores=M,a.getLocations=function(){return G},a.getSvgHeight=function(){return y},a.stateHover=p,a.stateHoverOut=q,a.clickState=n,a.locationHover=r,a.locationHoverOut=s,a.openLocation=w,a.getStateColor=l,a.getScoreColor=m,a.rangeColors=L,a.getStateName=j,a.getStateRangeLabel=k,a.comparator=T,a.reverseOrder=R,a.totalOrAverage=S}]),angular.module("choroplethApp").filter("capitalize",function(){return function(a,b){return a?a.replace(/([^\W_]+[^\s-]*) */g,function(a){return a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()}):""}}),angular.module("choroplethApp").filter("matchFIPS",["$filter",function(a){return function(a,b){if(!b)return a;var c=[];return angular.forEach(a,function(a){a.id===b&&c.push(a)}),c}}]),angular.module("choroplethApp").filter("matchStoreId",function(){return function(a,b){if(!b)return a;var c=[];return angular.forEach(a,function(a){a.storeId===b&&c.push(a)}),c}}),angular.module("choroplethApp").controller("LocationCtrl",["$scope","$timeout","$q","$http","$modalInstance","$window","location","GoogleURLs",function(a,b,c,d,e,f,g,h){function i(){function a(){return d({method:"GET",url:h.geoCode(),params:{address:p}})}var e=c.defer();return q?a().then(function(a){e.resolve(a.data.results[0].geometry.location),p=a.data.results[0].formatted_address},function(a){console.error(a)}):g.latitude&&g.longitude?b(function(){e.resolve({lat:g.latitude,lng:g.longitude})},0):e.reject("No valid address or lat/lng"),e.promise}function j(c){{var d=document.getElementById("mapCanvas"),e={center:new google.maps.LatLng(c.lat,c.lng),zoom:15,mapTypeId:google.maps.MapTypeId.ROADMAP},f=new google.maps.Map(d,e),h=new google.maps.Marker({map:f,position:e.center,title:g.longName});new google.maps.InfoWindow({content:r}).open(f,h)}n=document.getElementById("pac-input"),o=new google.maps.places.Autocomplete(n),angular.element(n).bind("blur",function(){b(function(){o.getPlace()&&(a.startAddr=o.getPlace().formatted_address)},50)})}function k(b){if(b&&a.placeSelected())var c=h.directions(o.getPlace().formatted_address,p);else if(!b)var c=h.directions(null,p);f.open(c,"_blank")}function l(){e.close()}function m(){e.dismiss()}var n,o,p=g.address+" "+g.addressLineTwo+" "+g.city+" "+g.stateAbbr+" "+g.postalCode,q=Boolean(g.address&&g.city&&g.stateAbbr),r="<strong>"+g.address+"</strong><br/>"+g.city+" "+g.stateAbbr+", "+g.postalCode;i().then(function(a,b){j(a,b)},function(a){console.error(a)}),a.ok=l,a.cancel=m,a.location=g,a.getDirections=k,a.placeSelected=function(){return o?o.getPlace():!1},a.validAddress=q}]),angular.module("choroplethApp").constant("GoogleApiKey","AIzaSyDCffNlD97LJaKJPJwLDrqPtHcF-UkPQ3A").constant("GoogleGeoCodeUrl","https://maps.googleapis.com/maps/api/geocode/json").constant("GoogleMapsDirectionsUrl","https://www.google.com/maps/dir/").constant("RangeColors",["#d7191c","#fdae61","#ffffbf","#a6d96a","#1a9641"]),angular.module("choroplethApp").service("GoogleURLs",["GoogleMapsDirectionsUrl","GoogleGeoCodeUrl",function(a,b){var c={directions:function(b,c){return c?a+(b?b+"/"+c:"Current+Location/"+c):void console.error("No Destination Provided for Directions Request.")},geoCode:function(){return b}};return c}]);