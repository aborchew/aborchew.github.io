"use strict";angular.module("choroplethApp",["ngAnimate","ngSanitize","ui.bootstrap"]),angular.module("choroplethApp").controller("MainCtrl",["$scope","$http","$q","$filter","$window","$timeout",function(a,b,c,d,e,f){function g(a){return y?y(a):"inherit"}function h(){var a=this.score.id,b=d("filter")(topojson.feature(w,w.objects.states).features,{id:a},!0)[0];i(b)}function i(b){G=!1,a.selectedStore=null;var c,d,e,g;if(g=2,b&&b.id&&C[b.id]){if(b&&(q&&q.id!==b.id||!q)){var h=t.centroid(b);c=h[0],d=h[1],e=4,q=b}else c=o/g,d=p/g,e=1,q=null;s.selectAll("path").classed("active",q&&function(a){return a===q}),s.transition().duration(F).attr("transform","translate("+o/g+","+p/g+")scale("+e+")translate("+-c+","+-d+")").style("stroke-width",1.5/e+"px"),v.transition().duration(F).attr("transform","translate("+o/g+","+p/g+")scale("+e+")translate("+-c+","+-d+")").selectAll("circle.location").attr("class",function(a){return q&&a.stateId===q.id?"location visible":"location"}).attr("r",function(a){return q&&a.stateId===q.id?1:0}).attr("data-store-id",function(a){return"store"+a.storeId}),F=750,f(function(){a.selectedStateId=q?q.id:null},0)}}function j(){if(!G){var a=this.location.storeId,b=v.select("[data-store-id=store"+a+"]");v.selectAll("circle.location").sort(function(b,c){return b.storeId!==a?-1:1}),b.classed("hovered",!0).transition().duration(500).attr("r",5)}}function k(){if(!G){var a=this.location.storeId,b=v.select("[data-store-id=store"+a+"]");b.classed("hovered",!1).transition().duration(500).attr("r",1)}}function l(){G=!G,G?a.selectedStore=this.location.storeId:a.selectedStore=null}function m(){function a(){var a;return angular.forEach(C,function(b){(!a||b.score<a)&&(a=b.score)}),a}function b(){var a;return angular.forEach(C,function(b){(!a||b.score>a)&&(a=b.score)}),a}var c;if(o=angular.element("#map").width(),p=.65*o,!o)return void f(m,0);c=d3.geo.albersUsa().scale(o).translate([o/2,p/2]),t=d3.geo.path().projection(c),u=d3.select("#map").append("svg").attr("width",o).attr("height",p),angular.forEach(C,function(a){a.score=a.tallies.reduce(function(a,b){return a+b},0)/a.tallies.length});var d,e=a(),g=b(),h=(g+e)/2;y=d3.scale.linear().domain([e,(h+e)/2,h,(h+g)/2,g]).range(["#d7191c","#fdae61","#ffffbf","#a6d96a","#1a9641"]),d=["<= "+Math.floor(y.domain()[0]),Math.floor(y.domain()[1])+" +",Math.floor(y.domain()[2])+" +",Math.floor(y.domain()[3])+" +",">= "+Math.floor(y.domain()[4])],s=u.append("g"),s.append("g").attr("class","states").selectAll("path").data(topojson.feature(w,w.objects.states).features).enter().append("path").attr("d",t).on("click",i).attr("fill",function(a){return C[a.id]?y(C[a.id].score):void 0}),s.append("path").datum(topojson.mesh(w,w.objects.states,function(a,b){return a!==b})).attr("class","state-borders").attr("d",t),v=u.append("g"),v.selectAll("circle.location").data(x).enter().append("circle").attr("class","location").attr("r",1).attr("transform",function(a){return"translate("+c([a.longitude,a.latitude])+")"});var j=u.selectAll("g.legend").data(y.domain()).enter().append("g").attr("class","legend"),k=20,l=20;j.append("rect").attr("x",20).attr("y",function(a,b){return p-b*l-2*l}).attr("width",k).attr("height",l).style("fill",function(a,b){return y(a)}).style("opacity",.8),j.append("text").attr("x",50).attr("y",function(a,b){return p-b*l-l-4}).text(function(a,b){return d[b]})}function n(){new Date-z<E?setTimeout(n,E):(u.classed("resizing",!1),D=!1,u.remove(),q=null,m(),r&&(F=0,i(r),r=null))}var o,p,q,r,s,t,u,v,w,x,y,z,A=b.get("scripts/us.json"),B=b.get("scripts/locationsList.json"),C={},D=!1,E=250,F=750,G=!1;c.all([A,B]).then(function(a){w=a[0].data,x=a[1].data.response.rowsX,angular.forEach(x,function(a){var b=a.stateId,c=100,d=0;a.metric=Math.floor(Math.random()*(c-d))+d+1,C[b]?C[b].tallies.push(a.metric):C[b]={tallies:[a.metric],stateName:a.state,id:b}}),m()}),e.onresize=function(){r=q,z=new Date,u.classed("resizing",!0),D===!1&&(D=!0,setTimeout(n,E))},a.scores=C,a.getLocations=function(){return x},a.getSvgHeight=function(){return p},a.clickState=h,a.locationHover=j,a.locationHoverOut=k,a.lockLocation=l,a.getColor=g}]),angular.module("choroplethApp").filter("capitalize",function(){return function(a,b){return a?a.replace(/([^\W_]+[^\s-]*) */g,function(a){return a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()}):""}}),angular.module("choroplethApp").filter("matchFIPS",["$filter",function(a){return function(a,b){if(!b)return a;var c=[];return angular.forEach(a,function(a){a.id===b&&c.push(a)}),c}}]),angular.module("choroplethApp").filter("matchStoreId",function(){return function(a,b){if(!b)return a;var c=[];return angular.forEach(a,function(a){a.storeId===b&&c.push(a)}),c}});