"use strict";angular.module("choroplethApp",["ngAnimate","ngSanitize","ui.bootstrap"]),angular.module("choroplethApp").controller("MainCtrl",["$scope","$http","$q","$filter","$window","$timeout",function(a,b,c,d,e,f){function g(a){return d("filter")(I,{id:a},!0)[0].stateName}function h(a){return d("filter")(I,{id:a},!0)[0].legendLabels}function i(a){return D?D(a):"inherit"}function j(a,b){var c=d("filter")(I,{id:b},!0);return 1===c.length&&c[0].colorScale?c[0].colorScale(a):"inherit"}function k(){var a=this.score.id,b=d("filter")(topojson.feature(B,B.objects.states).features,{id:a},!0)[0];l(b)}function l(b){M=!1,a.selectedStore=null;var c,e,g,h,i=d("filter")(I,{id:b.id},!0);if(h=2,b&&b.id&&1===i.length){if(b&&(v&&v.id!==b.id||!v)){var j=y.centroid(b);c=j[0],e=j[1],g=4,v=b}else c=t/h,e=u/h,g=1,v=null;x.selectAll("path").classed("active",v&&function(a){return a===v}),x.transition().duration(L).attr("transform","translate("+t/h+","+u/h+")scale("+g+")translate("+-c+","+-e+")").style("stroke-width",1.5/g+"px"),A.transition().duration(L).attr("transform","translate("+t/h+","+u/h+")scale("+g+")translate("+-c+","+-e+")").selectAll("circle.location").attr("class",function(a){return v&&a.stateId===v.id?"location visible":"location"}).attr("r",function(a){return v&&a.stateId===v.id?1:0}).attr("data-store-id",function(a){return"store"+a.storeId}),L=750,f(function(){a.selectedStateId=v?v.id:null},0)}}function m(){var a=z.select("[data-state-id=state"+this.score.id+"]");a.classed("hovered",!0)}function n(){var a=z.select("[data-state-id=state"+this.score.id+"]");a.classed("hovered",!1)}function o(){if(!M){var a=this.location.storeId,b=A.select("[data-store-id=store"+a+"]");A.selectAll("circle.location").sort(function(b,c){return b.storeId!==a?-1:1}),b.classed("hovered",!0).transition().duration(500).attr("r",5)}}function p(){if(!M){var a=this.location.storeId,b=A.select("[data-store-id=store"+a+"]");b.classed("hovered",!1).transition().duration(500).attr("r",1)}}function q(){M=!M,M?a.selectedStore=this.location.storeId:a.selectedStore=null}function r(){var a;if(t=angular.element("#map").width(),u=.65*t,!t)return void f(r,0);a=d3.geo.albersUsa().scale(t).translate([t/2,u/2]),y=d3.geo.path().projection(a),z=d3.select("#map").append("svg").attr("width",t).attr("height",u),angular.forEach(I,function(a){a.score=a.tallies.reduce(function(a,b){return a+b},0)/a.tallies.length});var b,c=d3.min(I,function(a){return a.score}),e=d3.max(I,function(a){return a.score}),g=(e+c)/2;D=d3.scale.linear().domain([c,(g+c)/2,g,(g+e)/2,e]).range(H),b=["<= "+Math.floor(D.domain()[0]),Math.floor(D.domain()[1])+" +",Math.floor(D.domain()[2])+" +",Math.floor(D.domain()[3])+" +",">= "+Math.floor(D.domain()[4])],x=z.append("g"),x.append("g").attr("class","states").selectAll("path").data(topojson.feature(B,B.objects.states).features).enter().append("path").attr("d",y).on("click",l).attr("data-state-id",function(a){return"state"+a.id}).attr("fill",function(a){var b=d("filter")(I,{id:a.id},!0);return 1===b.length?(a.hasScore=!0,a.scoreColor=D(b[0].score),a.scoreColor):void 0}).classed("state",function(a){return a.hasScore}).on("mouseover",function(a){a.hasScore&&d3.select(this).classed("hovered",!0)}).on("mouseout",function(a){a.hasScore&&d3.select(this).classed("hovered",!1)}),x.append("path").datum(topojson.mesh(B,B.objects.states,function(a,b){return a!==b})).attr("class","state-borders").attr("d",y),A=z.append("g"),A.selectAll("circle.location").data(C).enter().append("circle").attr("class","location").attr("r",1).attr("transform",function(b){return"translate("+a([b.longitude,b.latitude])+")"});var h=z.selectAll("g.legend").data(D.domain()).enter().append("g").attr("class","legend"),i=20,j=20;h.append("rect").attr("x",20).attr("y",function(a,b){return u-b*j-2*j}).attr("width",i).attr("height",j).style("fill",function(a,b){return D(a)}).style("opacity",.8),h.append("text").attr("x",50).attr("y",function(a,b){return u-b*j-j-4}).text(function(a,c){return b[c]})}function s(){new Date-E<K?setTimeout(s,K):(z.classed("resizing",!1),J=!1,z.remove(),v=null,r(),w&&(L=0,l(w),w=null))}var t,u,v,w,x,y,z,A,B,C,D,j,E,F=b.get("scripts/us.json"),G=b.get("scripts/locationsList.json"),H=["#d7191c","#fdae61","#ffffbf","#a6d96a","#1a9641"],I=[],J=!1,K=250,L=750,M=!1,N="score",O=!0;c.all([F,G]).then(function(a){B=a[0].data,C=a[1].data.response.rowsX,angular.forEach(C,function(a){var b=a.stateId,c=100,e=0,f=d("filter")(I,{id:b},!0);a.metric=Math.floor(Math.random()*(c-e))+e+1,1!==f.length?I.push({tallies:[a.metric],stateName:a.state,id:b}):f[0].tallies.push(a.metric)}),angular.forEach(I,function(a){var b=d3.min(a.tallies),c=d3.max(a.tallies),d=(b+c)/2;a.colorScale=d3.scale.linear().domain([b,(d+b)/2,d,(d+c)/2,c]).range(H),a.legendLabels=["<= "+Math.floor(a.colorScale.domain()[0]),Math.floor(a.colorScale.domain()[1])+" +",Math.floor(a.colorScale.domain()[2])+" +",Math.floor(a.colorScale.domain()[3])+" +",">= "+Math.floor(a.colorScale.domain()[4])],console.log(a)}),r()}),e.onresize=function(){w=v,E=new Date,z.classed("resizing",!0),J===!1&&(J=!0,setTimeout(s,K))},a.scores=I,a.getLocations=function(){return C},a.getSvgHeight=function(){return u},a.stateHover=m,a.stateHoverOut=n,a.clickState=k,a.locationHover=o,a.locationHoverOut=p,a.lockLocation=q,a.getStateColor=i,a.getScoreColor=j,a.rangeColors=H,a.getStateName=g,a.getStateRangeLabel=h,a.comparator=N,a.reverseOrder=O}]),angular.module("choroplethApp").filter("capitalize",function(){return function(a,b){return a?a.replace(/([^\W_]+[^\s-]*) */g,function(a){return a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()}):""}}),angular.module("choroplethApp").filter("matchFIPS",["$filter",function(a){return function(a,b){if(!b)return a;var c=[];return angular.forEach(a,function(a){a.id===b&&c.push(a)}),c}}]),angular.module("choroplethApp").filter("matchStoreId",function(){return function(a,b){if(!b)return a;var c=[];return angular.forEach(a,function(a){a.storeId===b&&c.push(a)}),c}});