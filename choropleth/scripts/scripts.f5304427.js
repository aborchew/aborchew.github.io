"use strict";angular.module("choroplethApp",["ngAnimate","ngSanitize","ui.bootstrap"]),angular.module("choroplethApp").controller("MainCtrl",["$scope","$http","$q","$filter",function(a,b,c,d){function e(){return q(this.score.score)}function f(){var a,b,c=this.score.id;angular.forEach(w,function(b){b.id===c&&(a=b)}),b=d("filter")(topojson.feature(n,n.objects.states).features,{id:c},!0)[0],b.score=a,g(b)}function g(a){var b,c,e,f,g;if(g=2,a.score){if(a&&(i&&i.id!==a.id||!i)){var h=k.centroid(a);b=h[0],c=h[1],e=4,i=a}else b=u/g,c=v/g,e=1,i=null;f=d("filter")(p,{id:a.id})[0].name.toLowerCase(),j.selectAll("path").classed("active",i&&function(a){return a===i}),j.transition().duration(750).attr("transform","translate("+u/g+","+v/g+")scale("+e+")translate("+-b+","+-c+")").style("stroke-width",1.5/e+"px"),m.transition().duration(750).attr("transform","translate("+u/g+","+v/g+")scale("+e+")translate("+-b+","+-c+")").selectAll("circle.location").attr("class",function(a){return i&&a.state.toLowerCase()===f?"location visible":"location"}).duration(750).attr("r",function(a){return i&&a.state.toLowerCase()===f?1:0})}}function h(a){function b(){var a;return angular.forEach(w,function(b){(!a||b.score<a)&&(a=b.score)}),a}function c(){var a;return angular.forEach(w,function(b){(!a||b.score>a)&&(a=b.score)}),a}n=a.map,o=a.locations.response.rowsX,p=a.fips;var e;e=d3.geo.albersUsa().scale(700).translate([u/2,v/2]),k=d3.geo.path().projection(e),l=d3.select("#map").append("svg").attr("width",u).attr("height",v),angular.forEach(o,function(a){var b,c=a.state.toLowerCase(),e=100,f=0;a.metric=Math.floor(Math.random()*(e-f))+f+1,b=d("filter")(p,function(a){return a.name.toLowerCase()==c}),w[c]?w[c].tallies.push(a.metric):(w[c]={tallies:[a.metric]},w[c].id=b[0].id),a.fipsStateId=b[0].id}),angular.forEach(w,function(a){a.score=a.tallies.reduce(function(a,b){return a+b},0)/a.tallies.length}),q=d3.scale.linear().domain([b(),c()]).range(["red","green"]),j=l.append("g"),j.append("g").attr("class","states").selectAll("path").data(topojson.feature(n,n.objects.states).features).enter().append("path").attr("d",k).on("click",g).attr("fill",function(a){var b=d("filter")(p,{id:a.id})[0];return a.score=w[b.name.toLowerCase()],a.score?q(a.score.score):void 0}),j.append("path").datum(topojson.mesh(n,n.objects.states,function(a,b){return a!==b})).attr("class","state-borders").attr("d",k),m=l.append("g"),m.selectAll("circle.location").data(o).enter().append("circle").attr("class","location").attr("r",1).attr("transform",function(a){return"translate("+e([a.longitude,a.latitude])+")"})}var i,j,k,l,m,n,o,p,q,r=b.get("scripts/us.json"),s=b.get("scripts/locationsList.json"),t=b.get("scripts/fips.json"),u=700,v=400,w={};c.all([r,s,t]).then(function(a){h({map:a[0].data,locations:a[1].data,fips:a[2].data})}),a.scores=w,a.clickState=f,a.getColor=e}]),angular.module("choroplethApp").filter("capitalize",function(){return function(a,b){return a?a.replace(/([^\W_]+[^\s-]*) */g,function(a){return a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()}):""}});